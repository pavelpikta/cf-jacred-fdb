# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–†—É—Å—Å–∫–∞—è –≤–µ—Ä—Å–∏—è)

> –Ø–∑—ã–∫–∏: üá∑üá∫ –†—É—Å—Å–∫–∏–π | [English](./ARCHITECTURE.md)

> –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–Ω—Ç–∞–π–º –º–æ–¥–µ–ª–∏ **cf-jacred-fbd**. –î–ª—è –∫—Ä–∞—Ç–∫–æ–≥–æ –æ–±–∑–æ—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–π —Å–º. `README.ru.md`.

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–ª–∞—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞](#–æ–±–ª–∞—Å—Ç—å-–¥–æ–∫—É–º–µ–Ω—Ç–∞)
2. [–í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –æ–±–∑–æ—Ä](#–≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π-–æ–±–∑–æ—Ä)
3. [–ö–æ–Ω–≤–µ–π–µ—Ä middleware](#–∫–æ–Ω–≤–µ–π–µ—Ä-middleware)
4. [–ú–∞—Ç—Ä–∏—Ü–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏](#–º–∞—Ç—Ä–∏—Ü–∞-–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏)
5. [–î–µ—Ä–µ–≤–æ —Ä–µ—à–µ–Ω–∏–π](#–¥–µ—Ä–µ–≤–æ-—Ä–µ—à–µ–Ω–∏–π)
6. [–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–¥–∏–∞–≥—Ä–∞–º–º—ã)](#–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏-–¥–∏–∞–≥—Ä–∞–º–º—ã)
7. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
8. [–ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã middleware](#–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã-middleware)
9. [–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–≤–∞–ª–∏–¥–∞—Ü–∏—è](#–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ-–∏-—Ä–µ–≤–∞–ª–∏–¥–∞—Ü–∏—è)
10. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
11. [–§–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫](#—Ñ–æ—Ä–º–∞—Ç-–æ—à–∏–±–æ–∫)
12. [–¢–æ—á–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è](#—Ç–æ—á–∫–∏-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)

---

## –û–±–ª–∞—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞

–û–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ—Ç–æ–∫ –∑–∞–ø—Ä–æ—Å–∞, –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ middleware, –º–æ–¥–µ–ª—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è, —Ç–æ—á–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è. –°–±–æ—Ä–∫–∞ –∏ workflow ‚Äî –≤ README.

## –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –æ–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –≤–∫–ª—é—á–∞–µ—Ç:

- **–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π UI** (–ü–æ–∏—Å–∫ + –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞) ‚Äî –∞—Å—Å–µ—Ç—ã Cloudflare Pages (ASSETS binding)
- **Edge Worker** ‚Äî `_worker.js` –≤—ã–ø–æ–ª–Ω—è–µ—Ç: –ø—Ä–æ–∫—Å–∏ –∫ –∞–ø—Å—Ç—Ä–∏–º—É, –ø–æ–º–æ—â–Ω–∏–∫–∏ TorrServer, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Ö–µ—à–µ–π
- **Upstream API** ‚Äî –ø—Ä–æ—Å—Ç–æ–π HTTP —Å–µ—Ä–≤–µ—Ä –∑–∞ Cloudflare
- **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π TorrServer** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä
- **Edge Cache** ‚Äî `caches.default` –¥–ª—è –∫–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏—Ö GET

### –î–∏–∞–≥—Ä–∞–º–º–∞

```mermaid
flowchart LR
  Browser[(Browser)] -->|HTTPS| Pages[Cloudflare Pages\n(Static)]
  Pages --> Worker[_worker.js\nPipeline]
  subgraph Edge[Cloudflare Edge]
    Worker --> Cache[(caches.default)]
  end
  Worker -->|/api/...| Upstream[(Upstream API)]
  Worker -->|/api/torrserver/*| TorrServer[(TorrServer)]
  Worker -. svc tokens .-> CFAccess[(CF Access)]
```

## –ö–æ–Ω–≤–µ–π–µ—Ä middleware

```text
statsAsset ‚Üí staticAsset ‚Üí methodAndCors ‚Üí torrserver ‚Üí confEndpoint ‚Üí upstream
```

–ü—Ä–∏—á–∏–Ω–∞ –ø–æ—Ä—è–¥–∫–∞: –±—ã—Å—Ç—Ä—ã–π –≤–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞—Ç–∏–∫–∏, —Ä–∞–Ω–Ω—è—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –º–µ—Ç–æ–¥–∞, –¥–æ–º–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –∑–∞—Ç–µ–º –æ–±—â–∏–π –ø—Ä–æ–∫—Å–∏.

## –ú–∞—Ç—Ä–∏—Ü–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

| –ü–æ—Ä—è–¥–æ–∫ | –ò–º—è             | –ò—Å—Ç–æ—á–Ω–∏–∫           | –ö–æ–≥–¥–∞                | –†–∞–Ω–Ω–∏–π –≤–æ–∑–≤—Ä–∞—Ç | –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã    |
| ------- | --------------- | ------------------ | -------------------- | -------------- | ------------------- |
| 1       | `statsAsset`    | `statsAsset.ts`    | –ü—É—Ç—å `/stats(.html)` | –í—Å–µ–≥–¥–∞         | –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–µ—à–∞      |
| 2       | `staticAsset`   | `staticAsset.ts`   | –ù–µ API –∏ –Ω–µ –ø—Ä—è–º–æ–π   | –í—Å–µ–≥–¥–∞         | –ú–∞–Ω–∏—Ñ–µ—Å—Ç, –∫–µ—à       |
| 3       | `methodAndCors` | `methodAndCors.ts` | –û—Å—Ç–∞—Ç–æ–∫              | 405 / 204      | CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏      |
| 4       | `torrserver`    | `torrserver.ts`    | `/api/torrserver/`   | JSON           | –°–µ—Ç–µ–≤—ã–µ –≤—ã–∑–æ–≤—ã      |
| 5       | `confEndpoint`  | `conf.ts`          | `/api/conf`          | JSON           | –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ |
| 6       | `upstream`      | `upstream.ts`      | –û—Å—Ç–∞–ª—å–Ω—ã–µ            | –û—à–∏–±–∫–∏/–ø—Ä–æ–∫—Å   | –ö–µ—à + –∑–∞–≥–æ–ª–æ–≤–∫–∏     |

## –î–µ—Ä–µ–≤–æ —Ä–µ—à–µ–Ω–∏–π

1. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞? ‚Üí –æ—Ç–¥–∞—Ç—å –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
2. –ù–µ API/–Ω–µ –ø—Ä—è–º–æ–π? ‚Üí —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞—Å—Å–µ—Ç
3. –ú–µ—Ç–æ–¥ –≤–∞–ª–∏–¥–µ–Ω? –∏–Ω–∞—á–µ 405/204
4. TorrServer –ø—É—Ç—å? –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
5. `/api/conf`? –≤–µ—Ä–Ω—É—Ç—å JSON
6. –ò–Ω–∞—á–µ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å (–∫–ª—é—á, –º–∞–ø–ø–∏–Ω–≥, –∫–µ—à, –∑–∞–≥–æ–ª–æ–≤–∫–∏)

## –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–¥–∏–∞–≥—Ä–∞–º–º—ã)

### –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞—Å—Å–µ—Ç

```mermaid
sequenceDiagram
  participant B as Browser
  participant W as Worker
  participant A as ASSETS
  B->>W: GET /css/styles.css
  W->>W: statsAsset skip
  W->>W: staticAsset serve
  W->>A: fetch file
  A-->>W: 200
  W-->>B: 200 cached
```

### –ü–æ–∏—Å–∫ —Ç–æ—Ä—Ä–µ–Ω—Ç–æ–≤

```mermaid
sequenceDiagram
  participant B as Browser
  participant W as Worker
  participant C as Cache
  participant U as Upstream
  B->>W: GET /api/torrents?search=q&apikey=K
  W->>W: methodAndCors
  W->>W: parse key
  W->>W: map path /api/torrents
  W->>W: strip key
  W->>C: cache.match
  alt HIT
    C-->>W: 200
    W-->>B: 200 (HIT)
  else MISS
    W->>U: fetch
    U-->>W: 200 JSON
    W->>C: cache.put
    W-->>B: 200 (MISS)
  end
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

```ts
interface RequestContext {
  request: Request;
  env: WorkerEnv;
  url: URL;
  pathname: string;
  start: number;
  config: ResolvedConfig;
  apiKey: ApiKeyInfo;
  isApi: boolean;
  direct: boolean;
  state: Record<string, unknown>;
  upstreamPath?: string;
  upstreamUrl?: URL;
}
```

## –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã middleware

| Middleware      | –í—Ö–æ–¥—ã                    | –î–æ–±. –ø–æ–ª—è                     | –û—à–∏–±–∫–∏          |
| --------------- | ------------------------ | ----------------------------- | --------------- |
| `statsAsset`    | `pathname`, `env.ASSETS` | ‚Äî                             | 404 passthrough |
| `staticAsset`   | `pathname`, manifest     | ‚Äî                             | 404 passthrough |
| `methodAndCors` | `request.method`         | ‚Äî                             | 405/204         |
| `torrserver`    | JSON —Ç–µ–ª–æ, —Ç–∞–π–º–∞—É—Ç       | ‚Äî                             | 400/502/504     |
| `confEndpoint`  | –∞–ø—Å—Ç—Ä–∏–º `/api/conf`      | ‚Äî                             | 403/—á–∞—Å—Ç–∏—á–Ω–æ    |
| `upstream`      | –º–∞–ø–ø–∏–Ω–≥ –ø—É—Ç–∏             | `upstreamPath`, `upstreamUrl` | 400/403/502/504 |

## –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–≤–∞–ª–∏–¥–∞—Ü–∏—è

- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª—é—á–∞ (—É–¥–∞–ª—è–µ–º `_`, `apikey`, `api_key`)
- ETag + —É—Å–ª–æ–≤–Ω—ã–π 304
- GET: `public, max-age=60, s-maxage=300`
- –•–µ—à –∞—Å—Å–µ—Ç—ã: `31536000, immutable`
- HTML: `no-cache`

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

| –ê—Å–ø–µ–∫—Ç           | –ú–µ—Ö–∞–Ω–∏–∑–º                          |
| ---------------- | --------------------------------- |
| –£—Ç–µ—á–∫–∞ API –∫–ª—é—á–∞ | –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ query –ø–µ—Ä–µ–¥ fetch     |
| Clickjacking     | `X-Frame-Options: DENY`           |
| MIME sniff       | `X-Content-Type-Options: nosniff` |
| Referrer         | `no-referrer`                     |
| XS-Leaks         | COOP + CORP                       |
| Permissions      | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π Permissions-Policy    |
| Cache poisoning  | –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á              |

–ë—É–¥—É—â–µ–µ: CSP, SRI, rate limiting, Turnstile.

## –§–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫

```json
{ "error": "–°–æ–æ–±—â–µ–Ω–∏–µ", "code": "upstream_timeout", "locale": "ru", "timeoutMs": 30000 }
```

## –¢–æ—á–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

| –ó–æ–Ω–∞                       | –ü–æ–¥—Ö–æ–¥                                          |
| -------------------------- | ----------------------------------------------- |
| –ù–æ–≤—ã–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç | Middleware –ø–µ—Ä–µ–¥ `upstream`                     |
| –î–æ–ø. –∑–∞–≥–æ–ª–æ–≤–∫–∏             | –†–∞—Å—à–∏—Ä–∏—Ç—å addStandardResponseHeaders            |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ                | Middleware –ø–æ—Å–ª–µ `methodAndCors`                |
| Rate limiting              | –í—Å—Ç–∞–≤–∏—Ç—å –¥–æ —Å–µ—Ç–µ–≤—ã—Ö –≤—ã–∑–æ–≤–æ–≤ (Durable Object/KV) |
| CSP                        | –î–æ–±–∞–≤–∏—Ç—å –≤ –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤             |

---

–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-09-23

---

üîÅ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —è–∑—ã–∫: [English architecture](./ARCHITECTURE.md)
