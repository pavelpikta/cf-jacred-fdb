# ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

> Ğ¯Ğ·Ñ‹ĞºĞ¸: ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹ | [English](./ARCHITECTURE.md)

> Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ñ€Ğ°Ğ½Ñ‚Ğ°Ğ¹Ğ¼-Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ **cf-jacred-fdb**. Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ñ… Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹ Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑĞ¼. [`README.ru.md`](./README.ru.md).

## ĞĞ³Ğ»Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ

- [ĞĞ±Ğ·Ğ¾Ñ€ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹](#Ğ¾Ğ±Ğ·Ğ¾Ñ€-ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹)
- [ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²](#Ğ¿Ğ¾Ñ‚Ğ¾Ğº-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²)
- [ĞšĞ¾Ğ½Ğ²ĞµĞ¹ĞµÑ€ middleware](#ĞºĞ¾Ğ½Ğ²ĞµĞ¹ĞµÑ€-middleware)
- [ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿ÑƒÑ‚ĞµĞ¹](#Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ-Ğ¿ÑƒÑ‚ĞµĞ¹)
- [ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ](#Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°-ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ)
- [ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸](#Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ-Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸)
- [ĞšĞ»Ğ¸ĞµĞ½Ñ‚ÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ](#ĞºĞ»Ğ¸ĞµĞ½Ñ‚ÑĞºĞ¸Ğµ-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ)
- [Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ñ‚Ğ¸Ğ¿Ğ¾Ğ²](#ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°-Ñ‚Ğ¸Ğ¿Ğ¾Ğ²)
- [Ğ ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ñ](#Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾-Ğ¿Ğ¾-Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ñ)

---

## ĞĞ±Ğ·Ğ¾Ñ€ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

### ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Cloudflare Edge                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Pages (R2)     â”‚    â”‚   _worker.js    â”‚    â”‚   caches.default        â”‚  â”‚
â”‚  â”‚  Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ    â”‚â—„â”€â”€â”€â”‚   Middleware    â”‚â”€â”€â”€â–ºâ”‚   Edge Cache            â”‚  â”‚
â”‚  â”‚  Ğ°ÑÑĞµÑ‚Ñ‹         â”‚    â”‚                 â”‚    â”‚                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                  â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                             â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ Upstream API  â”‚             â”‚  TorrServer   â”‚
           â”‚ (HTTP origin) â”‚             â”‚ (User-hosted) â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ‘Ğ¸Ğ½Ğ´Ğ¸Ğ½Ğ³Ğ¸

| Ğ‘Ğ¸Ğ½Ğ´Ğ¸Ğ½Ğ³          | Ğ¢Ğ¸Ğ¿       | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ                                     |
| ---------------- | --------- | ---------------------------------------------- |
| `ASSETS`         | R2/KV     | Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ°ÑÑĞµÑ‚Ğ¾Ğ² Cloudflare Pages |
| `caches.default` | Cache API | Edge-ĞºĞµÑˆ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ² Ğ°Ğ¿ÑÑ‚Ñ€Ğ¸Ğ¼Ğ°                  |

### ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

1. **Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€** â†’ HTTPS â†’ **Cloudflare Edge**
2. **Worker** Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ, Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ ĞºĞ¾Ğ½Ğ²ĞµĞ¹ĞµÑ€ middleware
3. **Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹** â†’ ASSETS binding (Ñ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸ĞµĞ¼ Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ°)
4. **API-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹** â†’ Upstream origin (Ñ ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼)
5. **TorrServer-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹** â†’ Ğ£ĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ TorrServer

---

## ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²

### Ğ”ĞµÑ€ĞµĞ²Ğ¾ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğ¹

```text
Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾ÑÑ‚ÑƒĞ¿Ğ°ĞµÑ‚
    â”‚
    â”œâ”€â–º Ğ­Ñ‚Ğ¾ /stats, /stats/, /stats.html?
    â”‚       â””â”€â–º statsAsset middleware â†’ Ğ¾Ñ‚Ğ´Ğ°Ñ‚ÑŒ stats.html
    â”‚
    â”œâ”€â–º Ğ­Ñ‚Ğ¾ Ğ½Ğµ-API, Ğ½Ğµ-direct Ğ¿ÑƒÑ‚ÑŒ?
    â”‚       â””â”€â–º staticAsset middleware â†’ Ğ¾Ñ‚Ğ´Ğ°Ñ‚ÑŒ Ğ¸Ğ· ASSETS
    â”‚
    â”œâ”€â–º ĞœĞµÑ‚Ğ¾Ğ´ Ñ€Ğ°Ğ·Ñ€ĞµÑˆÑ‘Ğ½ (GET/HEAD/POST/OPTIONS)?
    â”‚       â””â”€â–º ĞĞµÑ‚: Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ 405
    â”‚       â””â”€â–º OPTIONS: Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ 204 Ñ CORS
    â”‚
    â”œâ”€â–º Ğ­Ñ‚Ğ¾ /api/torrserver/*?
    â”‚       â””â”€â–º torrserver middleware â†’ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ add/test
    â”‚
    â”œâ”€â–º Ğ­Ñ‚Ğ¾ /api/conf?
    â”‚       â””â”€â–º confEndpoint middleware â†’ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
    â”‚
    â””â”€â–º ĞÑÑ‚Ğ°Ğ²ÑˆĞ¸ĞµÑÑ API/direct Ğ¿ÑƒÑ‚Ğ¸
            â””â”€â–º upstream middleware â†’ Ğ¿Ñ€Ğ¾ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğº origin
```

### ĞŸĞ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ: Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ°ÑÑĞµÑ‚

```text
Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€                  Worker                   ASSETS
   â”‚                        â”‚                        â”‚
   â”‚  GET /css/styles.css   â”‚                        â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                        â”‚
   â”‚                        â”‚  resolveHashedPath()   â”‚
   â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                        â”‚  fetch(hashed path)    â”‚
   â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚  200 + Cache-Control   â”‚                        â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
```

### ĞŸĞ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ: API-Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ

```text
Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€                  Worker                Cache              Upstream
   â”‚                        â”‚                    â”‚                    â”‚
   â”‚  GET /api/torrents     â”‚                    â”‚                    â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                    â”‚
   â”‚                        â”‚  parse API key     â”‚                    â”‚
   â”‚                        â”‚  map path          â”‚                    â”‚
   â”‚                        â”‚  strip apikey      â”‚                    â”‚
   â”‚                        â”‚  cache.match()     â”‚                    â”‚
   â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
   â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
   â”‚                        â”‚  [MISS]            â”‚                    â”‚
   â”‚                        â”‚  fetch upstream    â”‚                    â”‚
   â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                        â”‚  cache.put()       â”‚                    â”‚
   â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
   â”‚  200 + headers         â”‚                    â”‚                    â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚
```

### ĞŸĞ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ: TorrServer Add

```text
Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€                  Worker                           TorrServer
   â”‚                        â”‚                                  â”‚
   â”‚  POST /api/torrserver/add                                 â”‚
   â”‚  { magnet, url, ... }  â”‚                                  â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                  â”‚
   â”‚                        â”‚  Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ body                  â”‚
   â”‚                        â”‚  Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ auth headers         â”‚
   â”‚                        â”‚  POST /torrents                  â”‚
   â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚  { ok, status, ... }   â”‚                                  â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                  â”‚
```

---

## ĞšĞ¾Ğ½Ğ²ĞµĞ¹ĞµÑ€ middleware

### ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ

```typescript
const pipeline: Middleware[] = [
  statsAsset, // 1. Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸
  staticAsset, // 2. ĞĞ±Ñ‰Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ°ÑÑĞµÑ‚Ñ‹
  methodAndCors, // 3. Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ° + CORS
  torrserver, // 4. Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñ‹ TorrServer
  confEndpoint, // 5. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº /api/conf
  upstream, // 6. ĞŸÑ€Ğ¾ĞºÑĞ¸ Ğº Ğ°Ğ¿ÑÑ‚Ñ€Ğ¸Ğ¼Ñƒ (Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹)
];
```

### ĞšĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ñ‹ middleware

| Middleware      | Ğ¡Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ°      | Ğ Ğ°Ğ½Ğ½Ğ¸Ğ¹ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚       | ĞŸĞ¾Ğ±Ğ¾Ñ‡Ğ½Ñ‹Ğµ ÑÑ„Ñ„ĞµĞºÑ‚Ñ‹               |
| --------------- | ------------------- | -------------------- | ------------------------------ |
| `statsAsset`    | `/stats*` Ğ¿ÑƒÑ‚Ğ¸      | Ğ’ÑĞµĞ³Ğ´Ğ°               | Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ          |
| `staticAsset`   | ĞĞµ-API, Ğ½Ğµ-direct   | Ğ’ÑĞµĞ³Ğ´Ğ°               | ĞŸĞ¾Ğ¸ÑĞº Ğ² Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğµ, ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ |
| `methodAndCors` | Ğ’ÑĞµ Ğ¾ÑÑ‚Ğ°Ğ²ÑˆĞ¸ĞµÑÑ      | 405/204              | CORS-Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸                 |
| `torrserver`    | `/api/torrserver/*` | JSON-Ğ¾Ñ‚Ğ²ĞµÑ‚           | Ğ¡ĞµÑ‚ÑŒ Ğº TorrServer              |
| `confEndpoint`  | `/api/conf`         | JSON-ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³          | Fetch Ğº Ğ°Ğ¿ÑÑ‚Ñ€Ğ¸Ğ¼Ñƒ               |
| `upstream`      | API/direct Ğ¿ÑƒÑ‚Ğ¸     | ĞŸÑ€Ğ¾ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ | Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ/Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ ĞºĞµÑˆĞ°             |

### Ğ¢Ğ¸Ğ¿ middleware

```typescript
interface RequestContext {
  request: Request;
  env: WorkerEnv;
  ctx: ExecutionContext;
  url: URL;
  pathname: string;
  start: number;
  config: ResolvedConfig;
  apiKey: ApiKeyInfo;
  locale: Locale;
  isApi: boolean;
  direct: boolean;
  upstreamPath?: string;
  upstreamUrl?: URL;
  state: Record<string, unknown>;
}

type Middleware = (ctx: RequestContext) => Promise<Response | void> | Response | void;
```

---

## ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿ÑƒÑ‚ĞµĞ¹

### ĞœĞ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¿ÑƒÑ‚ĞµĞ¹ Ğº Ğ°Ğ¿ÑÑ‚Ñ€Ğ¸Ğ¼Ñƒ

```typescript
const RULES: MappingRule[] = [
  // /api/conf â†’ /api/v1.0/conf
  { type: 'regex', test: /^(\/conf\/?$)/, to: () => '/api/v1.0/conf' },

  // /api/torrents â†’ /api/v1.0/torrents
  { type: 'predicate', test: (a) => a.startsWith('/torrents'), to: () => '/api/v1.0/torrents' },

  // /api/stats â†’ /stats (passthrough)
  { type: 'regex', test: /^(\/stats\/?$)/, to: () => '/stats' },
  { type: 'predicate', test: (a) => a.startsWith('/stats/'), to: (a) => a },

  // /api/v1/... â†’ /api/v1/... (Ğ²ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ passthrough)
  { type: 'regex', test: /^\/v\d/, to: (a) => '/api' + a },

  // Catch-all: /api/foo â†’ /api/foo
  { type: 'predicate', test: () => true, to: (a) => '/api' + a },
];
```

### ĞŸÑ€ÑĞ¼Ñ‹Ğµ passthrough-Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑÑ‹

Ğ­Ñ‚Ğ¸ Ğ¿ÑƒÑ‚Ğ¸ Ğ¾Ğ±Ñ…Ğ¾Ğ´ÑÑ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ `/api` Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑĞ°:

```typescript
const DIRECT_PREFIXES = ['/stats', '/stats/', '/sync', '/sync/', '/lastupdatedb', '/health'];
const DIRECT_API_KEY_EXEMPT_PREFIXES = ['/lastupdatedb', '/health'];
```

---

## ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

### Ğ¡Ğ»Ğ¾Ğ¸ ĞºĞµÑˆĞ°

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ĞšĞµÑˆ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ°                            â”‚
â”‚  HTML: no-cache â”‚ Ğ¥ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ: immutable â”‚ API: max-age=60 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cloudflare Edge Cache                     â”‚
â”‚           caches.default â”‚ s-maxage=300 Ğ´Ğ»Ñ API             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Upstream Origin                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cache-Control Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ°ÑÑĞµÑ‚Ğ°

| ĞÑÑĞµÑ‚                 | Cache-Control                         | ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°                        |
| --------------------- | ------------------------------------- | ------------------------------ |
| HTML                  | `no-cache, must-revalidate`           | Ğ’ÑĞµĞ³Ğ´Ğ° ÑĞ²ĞµĞ¶Ğ¸Ğ¹ UX               |
| Ğ¥ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ CSS/JS   | `public, max-age=31536000, immutable` | ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚-Ğ°Ğ´Ñ€ĞµÑÑƒĞµĞ¼Ñ‹Ğµ             |
| ĞĞµÑ…ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ CSS/JS | `public, max-age=3600`                | 1 Ñ‡Ğ°Ñ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ             |
| Ğ˜Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ/ÑˆÑ€Ğ¸Ñ„Ñ‚Ñ‹    | `public, max-age=604800`              | 1 Ğ½ĞµĞ´ĞµĞ»Ñ                       |
| Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ API          | `public, max-age=60, s-maxage=300`    | ĞšĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€, Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ğ¹ edge |
| ĞÑˆĞ¸Ğ±ĞºĞ° API            | `no-cache, max-age=0`                 | ĞĞ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸   |

### ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ»ÑÑ‡Ğ° ĞºĞµÑˆĞ°

```typescript
function buildCacheKey(request: Request, upstreamUrl: string): Request {
  const u = new URL(upstreamUrl);
  u.searchParams.delete('_'); // Cache-busting Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€
  u.searchParams.delete('apikey'); // ĞŸÑ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ per-user Ñ„Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸
  u.searchParams.delete('api_key');
  return new Request(u.toString(), { method: 'GET' });
}
```

### ETag-Ñ€ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ

```typescript
// ĞŸÑ€Ğ¸ cache HIT Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ¼ If-None-Match:
const inm = request.headers.get('If-None-Match');
const cachedEtag = headers.get('ETag');

if (inm && cachedEtag) {
  const tokens = inm.split(',').map((s) => s.trim().replace(/^W\/|"/g, ''));
  const normalized = cachedEtag.replace(/^W\/|"/g, '');

  if (tokens.includes(normalized) || tokens.includes('*')) {
    return new Response(null, { status: 304, headers: h304 });
  }
}
```

---

## ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸

### ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ²

```typescript
function addStandardResponseHeaders(h: Headers): void {
  h.set('X-Content-Type-Options', 'nosniff');
  h.set('Referrer-Policy', 'no-referrer');
  h.set('X-Frame-Options', 'DENY');
  h.set('Cross-Origin-Opener-Policy', 'same-origin');
  h.set('Cross-Origin-Resource-Policy', 'same-origin');
  h.set('Permissions-Policy', 'geolocation=(), microphone=(), camera=(), fullscreen=(self)');
  // CORS-Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑÑÑ‚ÑÑ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾
}
```

### ĞŸĞ¾Ñ‚Ğ¾Ğº API-ĞºĞ»ÑÑ‡Ğ°

```typescript
interface ApiKeyInfo {
  keyEnforced: boolean; // Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ API_KEY
  suppliedKey: string | null; // ĞšĞ»ÑÑ‡ Ğ¸Ğ· query-Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°
  keyValid: boolean; // ĞšĞ»ÑÑ‡ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ñ Ñ€Ğ°Ğ·Ñ€ĞµÑˆÑ‘Ğ½Ğ½Ñ‹Ğ¼ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ¼
  allowedKeys: string[]; // ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ğ¸Ğ· API_KEY (Ñ‡ĞµÑ€ĞµĞ· Ğ·Ğ°Ğ¿ÑÑ‚ÑƒÑ)
}

// ĞšĞ»ÑÑ‡ ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚ÑÑ Ğ¿ĞµÑ€ĞµĞ´ fetch Ğº Ğ°Ğ¿ÑÑ‚Ñ€Ğ¸Ğ¼Ñƒ:
function stripApiKeyFromParams(params: URLSearchParams): boolean {
  params.delete('apikey');
  params.delete('api_key');
}
```

### Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ hop-by-hop Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ²

```typescript
const STRIP_RESPONSE_HEADERS = [
  'set-cookie',
  'transfer-encoding',
  'connection',
  'keep-alive',
  'te',
  'trailer',
  'upgrade',
];
```

### Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ ÑƒĞ³Ñ€Ğ¾Ğ·

| Ğ£Ğ³Ñ€Ğ¾Ğ·Ğ°           | Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ°                                             |
| ---------------- | -------------------------------------------------- |
| Ğ£Ñ‚ĞµÑ‡ĞºĞ° API-ĞºĞ»ÑÑ‡Ğ° | Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸Ğ· URL Ğ°Ğ¿ÑÑ‚Ñ€Ğ¸Ğ¼Ğ° Ğ¸ ĞºĞ»ÑÑ‡Ğ° ĞºĞµÑˆĞ°              |
| Clickjacking     | `X-Frame-Options: DENY`                            |
| MIME sniffing    | `X-Content-Type-Options: nosniff`                  |
| Ğ£Ñ‚ĞµÑ‡ĞºĞ° Referrer  | `Referrer-Policy: no-referrer`                     |
| XS-Leaks         | COOP + CORP Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸                              |
| Cache poisoning  | ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ»ÑÑ‡Ğ¸ ĞºĞµÑˆĞ°, ÑĞ°Ğ½Ğ¸Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ² |

---

## ĞšĞ»Ğ¸ĞµĞ½Ñ‚ÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ

### Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ¿Ğ¾Ğ¸ÑĞºĞ° (`index.js`)

**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°:**

- IIFE-Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½ (Ğ±ĞµĞ· Ğ·Ğ°Ğ³Ñ€ÑĞ·Ğ½ĞµĞ½Ğ¸Ñ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½ÑÑ‚Ğ²Ğ°)
- DOM-Ğ¼Ğ°Ğ½Ğ¸Ğ¿ÑƒĞ»ÑÑ†Ğ¸Ğ¸ Ğ½Ğ° jQuery
- Ğ”ĞµĞ»ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ°
- ĞœĞ¾Ğ´ÑƒĞ»ÑŒĞ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²

**Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼:**

```javascript
let allResults = []; // Ğ¡Ñ‹Ñ€Ñ‹Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ API
let filteredResults = []; // ĞŸĞ¾ÑĞ»Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ÑĞºĞ¾Ğ¹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸

const filterCache = {
  voice: [], // ĞĞ¿Ñ†Ğ¸Ğ¸ Ğ¾Ğ·Ğ²ÑƒÑ‡ĞºĞ¸
  tracker: [], // Ğ˜Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ñ‹ Ñ‚Ñ€ĞµĞºĞµÑ€Ğ¾Ğ²
  year: [], // Ğ“Ğ¾Ğ´Ñ‹ Ğ²Ñ‹Ğ¿ÑƒÑĞºĞ°
  season: [], // ĞĞ¾Ğ¼ĞµÑ€Ğ° ÑĞµĞ·Ğ¾Ğ½Ğ¾Ğ²
  category: [], // Ğ¢Ğ¸Ğ¿Ñ‹ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¹
  quality: [], // Ğ£Ñ€Ğ¾Ğ²Ğ½Ğ¸ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ²Ğ¸Ğ´ĞµĞ¾
};
```

**ĞŸĞ¾Ñ‚Ğ¾Ğº Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸:**

```text
API Response â†’ allResults â†’ applyFilters() â†’ filteredResults â†’ render()
                                  â†‘
                           Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ UI Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²
```

### Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ (`stats.js`)

**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°:**

- ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ (jQuery, ApiKey)
- localStorage-ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (5-Ğ¼Ğ¸Ğ½ÑƒÑ‚Ğ½Ñ‹Ğ¹ TTL)
- ĞĞ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ (10 Ğ¼Ğ¸Ğ½ÑƒÑ‚, Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸)
- ĞŸĞµÑ€ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ñ‚ĞµĞ¼Ñ‹/Ğ»ĞµĞ¹Ğ°ÑƒÑ‚Ğ°

**Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼:**

```javascript
let rawData = []; // Ğ’ÑÑ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ñ‚Ñ€ĞµĞºĞµÑ€Ğ¾Ğ²
let viewData = []; // ĞÑ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ/Ğ¾Ñ‚ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ

// ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ² localStorage:
// - statsCacheV1: { ts, data }
// - statsTheme: 'dark' | 'light'
// - statsWide: '0' | '1'
// - statsCompact: '0' | '1'
// - statsNumbersFull: '0' | '1'
```

### ĞœĞ¾Ğ´ÑƒĞ»ÑŒ API-ĞºĞ»ÑÑ‡Ğ° (`modal.apikey.js`)

**ĞŸÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ API:**

```javascript
ApiKey.ensure(callback); // Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ÑŒÑÑ Ğ² Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚Ğ¸ ĞºĞ»ÑÑ‡Ğ°, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ callback
ApiKey.get(); // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡
ApiKey.reset(); // ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡
ApiKey.promptReplace(cb); // ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»ÑÑ‡
```

**ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸:**

```text
ensure() â†’ fetchConf() â†’ requireApiKey?
              â”‚                 â”‚
              â”‚                 â”œâ”€â–º ĞĞµÑ‚: callback()
              â”‚                 â”‚
              â”‚                 â””â”€â–º Ğ”Ğ°: ĞºĞ»ÑÑ‡ Ğ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½?
              â”‚                           â”‚
              â”‚                           â”œâ”€â–º Ğ”Ğ°: callback()
              â”‚                           â”‚
              â”‚                           â””â”€â–º ĞĞµÑ‚: showModal() â†’ validate â†’ store â†’ callback()
```

### ĞœĞ¾Ğ´ÑƒĞ»ÑŒ TorrServer (`torrserver.js`)

**ĞŸÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ API:**

```javascript
TorrServer.openSettings(); // ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº
TorrServer.sendMagnet(magnet); // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ magnet Ğ² TorrServer
TorrServer.getConf(); // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ (Ğ±ĞµĞ· Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ)
TorrServer.getConfWithPassword(); // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ Ñ Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¼
TorrServer.clearPassword(url, user); // ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
```

**Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ:**

```text
ĞœĞ°ÑÑ‚ĞµÑ€-Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾) â†’ PBKDF2 â†’ AES-GCM Key â†’ Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
                                                           â”‚
                                                           â–¼
                                              sessionStorage Ğ¸Ğ»Ğ¸ localStorage
```

---

## Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ñ‚Ğ¸Ğ¿Ğ¾Ğ²

### ĞĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ Worker

```typescript
interface EnvLike {
  ASSETS: { fetch(request: Request): Promise<Response> };
  UPSTREAM_ORIGIN?: string;
  API_KEY?: string;
  CF_ACCESS_CLIENT_ID?: string;
  CF_ACCESS_CLIENT_SECRET?: string;
  UPSTREAM_TIMEOUT_MS?: string;
  TORRSERVER_TIMEOUT_MS?: string;
  ERROR_LOCALE?: string;
}
```

### ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ

```typescript
interface ResolvedConfig {
  upstreamOrigin: string; // Ğ˜Ğ· UPSTREAM_ORIGIN Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
  upstreamTimeoutMs: number; // ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ğ¸Ğ· UPSTREAM_TIMEOUT_MS
  torrTimeoutMs: number; // ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ğ¸Ğ· TORRSERVER_TIMEOUT_MS
}
```

### ĞĞ±Ñ‘Ñ€Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸

```typescript
interface ErrorEnvelope {
  error: string; // Ğ§ĞµĞ»Ğ¾Ğ²ĞµĞºĞ¾Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
  code?: string; // ĞœĞ°ÑˆĞ¸Ğ½Ğ¾Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼Ñ‹Ğ¹ ĞºĞ¾Ğ´
  locale?: string; // 'en' | 'ru'
  messageKey?: string; // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ i18n-ĞºĞ»ÑÑ‡
  [k: string]: unknown; // Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚
}
```

### Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ»Ğ¾ĞºĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

```typescript
type Locale = 'en' | 'ru';

type MsgKey =
  | 'not_found'
  | 'bad_request'
  | 'method_not_allowed'
  | 'forbidden'
  | 'upstream_timeout'
  | 'upstream_fetch_failed'
  | 'torrserver_timeout'
  | 'torrserver_network'
  | 'torrserver_all_attempts_failed'
  | 'missing_url'
  | 'invalid_url'
  | 'expect_json_body'
  | 'invalid_magnet'
  | 'auth_credentials_mismatch'
  | 'auth_error_hint'
  | 'auth_error_hint_tokens'
  | 'path_decode_error'
  | 'path_map_error';
```

---

## Ğ ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ñ

### Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ middleware

1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ `src/middleware/myMiddleware.ts`:

```typescript
import type { Middleware } from './types';

export const myMiddleware: Middleware = async (ctx) => {
  // Ğ’ĞµÑ€Ğ½Ğ¸Ñ‚Ğµ Response Ğ´Ğ»Ñ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ ĞºĞ¾Ğ½Ğ²ĞµĞ¹ĞµÑ€Ğ°, Ğ¸Ğ»Ğ¸ void Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ
  if (ctx.pathname === '/my-endpoint') {
    return new Response(JSON.stringify({ ok: true }), {
      headers: { 'Content-Type': 'application/json' },
    });
  }
  // ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ğ¹Ñ‚Ğµ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¼Ñƒ middleware
};
```

2. Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ· `src/middleware/index.ts`:

```typescript
export { myMiddleware } from './myMiddleware';
```

3. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ² ĞºĞ¾Ğ½Ğ²ĞµĞ¹ĞµÑ€ Ğ² `src/worker.ts`:

```typescript
const pipeline: Middleware[] = [
  statsAsset,
  staticAsset,
  methodAndCors,
  myMiddleware, // Ğ’ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ² Ğ½ÑƒĞ¶Ğ½ÑƒÑ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ
  torrserver,
  confEndpoint,
  upstream,
];
```

### Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ğ° Ğ¿ÑƒÑ‚Ğ¸

ĞÑ‚Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ `src/lib/routing.ts`:

```typescript
const RULES: MappingRule[] = [
  // Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ĞµÑ€ĞµĞ´ catch-all:
  {
    type: 'predicate',
    test: (a) => a.startsWith('/mypath'),
    to: (a) => '/api/v2' + a,
  },
  // ... ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°
];
```

### Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ

1. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ĞºĞ»ÑÑ‡ Ğ² `src/lib/i18n.ts`:

```typescript
type MsgKey /* ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ */ = 'my_error';

const RU: LocalePack = {
  messages: {
    // ... ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ
    my_error: 'ĞœĞ¾Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°',
  },
};

const EN: LocalePack = {
  messages: {
    // ... ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ
    my_error: 'My error',
  },
};
```

2. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ² ĞºĞ¾Ğ´Ğµ:

```typescript
import { errorResponse } from './errors';
return errorResponse(ctx.locale, 'my_error', 'my_error', 400);
```

### Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ² Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸

ĞÑ‚Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ `src/lib/security.ts`:

```typescript
export function addStandardResponseHeaders(h: Headers): void {
  // ... ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸
  h.set('My-Custom-Header', 'value');
}
```

### Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€ÑĞ¼Ğ¾Ğ³Ğ¾ passthrough-Ğ¿ÑƒÑ‚Ğ¸

ĞÑ‚Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ `src/lib/constants.ts`:

```typescript
export const DIRECT_PREFIXES = [
  // ... ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ
  '/mypath',
  '/mypath/',
] as const;

// Ğ•ÑĞ»Ğ¸ Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´Ñ‘Ğ½ Ğ¾Ñ‚ API-ĞºĞ»ÑÑ‡Ğ°:
export const DIRECT_API_KEY_EXEMPT_PREFIXES = [
  // ... ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ
  '/mypath',
] as const;
```

---

## Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑĞ±Ğ¾Ñ€ĞºĞ¸

### Ğ¥ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ°ÑÑĞµÑ‚Ğ¾Ğ²

`scripts/copy-static.mjs` Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚:

1. ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ `public/` Ğ² `dist/`
2. Ğ•ÑĞ»Ğ¸ `ASSET_HASH=1`:
   - Ğ¥ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ CSS/JS Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² (SHA-256, 10 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)
   - ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² `filename.{hash}.ext`
   - ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑÑ‹Ğ»Ğ¾Ğº Ğ² HTML
   - Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ `asset-manifest.json`
3. Ğ•ÑĞ»Ğ¸ `MINIFY=1`:
   - ĞœĞ¸Ğ½Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ CSS/JS Ñ‡ĞµÑ€ĞµĞ· esbuild

### Ğ Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ°

```typescript
// src/lib/manifest.ts
async function resolveHashedPath(env: EnvLike, pathname: string): Promise<string> {
  // ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ĞµÑĞ»Ğ¸ ÑƒĞ¶Ğµ Ñ…ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾
  if (/[.-][a-f0-9]{8,}\.[a-z0-9]+$/i.test(pathname)) return pathname;

  // Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚ Ğ¸Ğ· ASSETS (ĞºĞµÑˆĞ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ² Ğ¸Ğ·Ğ¾Ğ»ÑÑ‚Ğµ)
  await load(env);

  // ĞĞ°Ğ¹Ñ‚Ğ¸ Ñ…ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ
  const key = pathname.startsWith('/') ? pathname.slice(1) : pathname;
  return state.map[key] ? '/' + state.map[key] : pathname;
}
```

---

_ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: 2025-11-27_

---

ğŸ” ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ ÑĞ·Ñ‹Ğº: [English architecture](./ARCHITECTURE.md)
